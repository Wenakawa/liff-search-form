<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Size Limit</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 600px; margin: 0 auto; }
        h1 { color: #06C755; text-align: center; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; border: none; border-radius: 8px; background-color: #06C755; color: white; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 1rem; }
        button:disabled { background-color: #b2b2b2; cursor: not-allowed; }
        #loading { text-align: center; margin-top: 20px; font-size: 16px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Size Limit</h1>
        <form id="searchForm"></form>
        <button id="submitButton" disabled>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</button>
        <div id="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const LIFF_ID = '2008056084-rnwNKN2w'; 
            const TRIGGER_URL = 'https://us-central1-c--owlc.cloudfunctions.net/dialogflowFirebaseFulfillment';

            // --- (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö) ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô Dropdowns ---
            const options = {
                size_limit: ["*", "290", "340",	"400", "440", "490", "540", "590", "330IF", "IFX", "S45", "SPA"],
                prod_cd: ["HC", "HP", "HK", "HT"],
                enduse: ["", "*", "IDX", "IGX", "IDR", "IGR", "45C", "SDX", "PNX", "BXX"],
                application: ["", "X", "Y", "Q", "P", "C", "D",	"E", "G", "B", "L", "M", "N", "O", "K", "A", "F", "S", "*"],
                trim_fl: ["", "Y", "N"]
            };


            const form = document.getElementById('searchForm');
            const submitButton = document.getElementById('submitButton');
            const loadingDiv = document.getElementById('loading');

            function createForm() { /* ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */ }

            async function main() { /* ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */ }

            main();

            submitButton.addEventListener('click', async () => {
                const searchData = {
                    size_limit: document.getElementById('size_limit').value,
                    prod_cd: document.getElementById('prod_cd').value,
                    thk: parseFloat(document.getElementById('thk').value),
                    wid: parseFloat(document.getElementById('wid').value),
                    enduse: document.getElementById('enduse').value,
                    application: document.getElementById('application').value,
                    trim_fl: document.getElementById('trim_fl').value,
                };

                if (!searchData.thk || !searchData.wid) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• THk ‡πÅ‡∏•‡∏∞ Wid ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                    return;
                }

                submitButton.style.display = 'none';
                loadingDiv.style.display = 'block';

                try {
                    const response = await fetch(TRIGGER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(searchData)
                    });

                    if (!response.ok) {
                        throw new Error(`Server error: ${response.statusText}`);
                    }

                    const result = await response.json();

                    // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å searchParams ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
                    const queryParams = result.searchParams;
                    let reviewText = `üîé ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:\n`;
                    reviewText += `Size Limit: ${queryParams.size_limit}\n`;
                    reviewText += `Prod-CD: ${queryParams.prod_cd}\n`;
                    reviewText += `THk: ${queryParams.thk}\n`;
                    reviewText += `Wid: ${queryParams.wid}`;
                    if(queryParams.enduse) reviewText += `\nEnduse: ${queryParams.enduse}`;
                    if(queryParams.application) reviewText += `\nApplication: ${queryParams.application}`;
                    if(queryParams.trim_fl) reviewText += `\nTrim_FL: ${queryParams.trim_fl}`;

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å resultMessage
                    const resultText = `\n\n‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:\n${result.resultMessage}`;

                    // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
                    const finalMessage = reviewText + resultText;
                    // --- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

                    if (liff.isInClient()) {
                        await liff.sendMessages([{ type: 'text', text: finalMessage }]);
                        liff.closeWindow();
                    } else {
                        // ‡πÅ‡∏õ‡∏•‡∏á \n ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô alert ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
                        alert(finalMessage.replace(/\n/g, '\n'));
                    }

                } catch (error) {
                    console.error('Search failed:', error);
                    alert('‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                } finally {
                    submitButton.style.display = 'block';
                    loadingDiv.style.display = 'none';
                }
            });

            // --- ‡πÉ‡∏™‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô createForm ‡πÅ‡∏•‡∏∞ main ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ---
            function createForm() {
                form.innerHTML = `
                    <div class="form-group"><label for="size_limit">1. Size Limit</label><select id="size_limit" required>${options.size_limit.map(o => `<option value="${o}">${o}</option>`).join('')}</select></div>
                    <div class="form-group"><label for="prod_cd">2. Prod-CD</label><select id="prod_cd" required>${options.prod_cd.map(o => `<option value="${o}">${o}</option>`).join('')}</select></div>
                    <div class="form-group"><label for="thk">3. THk (‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)</label><input type="number" id="thk" step="0.01" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 2.3"></div>
                    <div class="form-group"><label for="wid">4. Wid (‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)</label><input type="number" id="wid" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 1219"></div>
                    <div class="form-group"><label for="enduse">5. Enduse (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label><select id="enduse">${options.enduse.map(o => `<option value="${o}">${o || '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}</option>`).join('')}</select></div>
                    <div class="form-group"><label for="application">6. Application (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label><select id="application">${options.application.map(o => `<option value="${o}">${o || '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}</option>`).join('')}</select></div>
                    <div class="form-group"><label for="trim_fl">7. Trim_FL (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label><select id="trim_fl">${options.trim_fl.map(o => `<option value="${o}">${o || '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'}</option>`).join('')}</select></div>
                `;
            }

            async function main() {
                try {
                    await liff.init({ liffId: LIFF_ID });
                    if (!liff.isLoggedIn()) { liff.login(); return; }
                    createForm();
                    submitButton.disabled = false;
                    submitButton.textContent = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                } catch (error) {
                    console.error('LIFF Initialization failed', error);
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                }
            }
        });
    </script>
</body>
</html>